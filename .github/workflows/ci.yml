name: CI

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ '*' ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      person-service: ${{ steps.filter.outputs.person-service }}
      game-service: ${{ steps.filter.outputs.game-service }}
      queue-service: ${{ steps.filter.outputs.queue-service }}
      stats-service: ${{ steps.filter.outputs.stats-service }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'api/**'
            person-service:
              - 'person-service/**'
            game-service:
              - 'game-service/**'
            queue-service:
              - 'queue-service/**'
            stats-service:
              - 'stats-service/**'
            infrastructure:
              - 'infrastructure/**'
              - 'docker-compose.yml'
              - 'Makefile'

  build-and-test:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: |
      needs.detect-changes.outputs.api == 'true' ||
      needs.detect-changes.outputs.person-service == 'true' ||
      needs.detect-changes.outputs.game-service == 'true' ||
      needs.detect-changes.outputs.queue-service == 'true' ||
      needs.detect-changes.outputs.stats-service == 'true' ||
      needs.detect-changes.outputs.infrastructure == 'true'
    
    services:
      postgres-person:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: person
        ports:
          - 5434:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres-queue:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: queue
        ports:
          - 5435:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres-game:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: game
        ports:
          - 5436:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres-stats:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: stats
        ports:
          - 5437:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make gradlew executable
        run: |
          chmod +x api/gradlew
          chmod +x person-service/gradlew
          chmod +x game-service/gradlew
          chmod +x queue-service/gradlew
          chmod +x stats-service/gradlew

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.m2/repository
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build and test Person Service
        if: |
          needs.detect-changes.outputs.person-service == 'true' ||
          needs.detect-changes.outputs.infrastructure == 'true' ||
          needs.detect-changes.outputs.api == 'true'
        working-directory: ./person-service
        run: ./gradlew build publishAllPublicationsToMavenLocalRepository --no-daemon

      - name: Build and test API
        if: |
          needs.detect-changes.outputs.api == 'true' ||
          needs.detect-changes.outputs.infrastructure == 'true'
        working-directory: ./api
        run: ./gradlew build --no-daemon

      - name: Build and test Game Service
        if: |
          needs.detect-changes.outputs.game-service == 'true' ||
          needs.detect-changes.outputs.infrastructure == 'true'
        working-directory: ./game-service
        run: ./gradlew build --no-daemon

      - name: Build and test Queue Service
        if: |
          needs.detect-changes.outputs.queue-service == 'true' ||
          needs.detect-changes.outputs.infrastructure == 'true'
        working-directory: ./queue-service
        run: ./gradlew build --no-daemon

      - name: Build and test Stats Service
        if: |
          needs.detect-changes.outputs.stats-service == 'true' ||
          needs.detect-changes.outputs.infrastructure == 'true'
        working-directory: ./stats-service
        run: ./gradlew build --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/build/test-results/**/*.xml
            **/build/reports/tests/**/*
          retention-days: 7

